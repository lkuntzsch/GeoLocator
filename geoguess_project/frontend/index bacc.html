<!DOCTYPE html>
<html>
<head>
  <title>Bildbasierte Geolokalisierung</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background-image: url("data/background.jpg"); /* Pfad zum Bild */
      background-size: cover;   /* skaliert es schön */
      background-position: center; /* zentriert das Bild */
      background-repeat: no-repeat; /* kein Kacheln */
      background-attachment: fixed; /* bleibt beim Scrollen */
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    #uploadArea, #uploadAreaSmall {
      border: 3px dashed #007bff;
      border-radius: 10px;
      color: #007bff;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 10px;
    }

    #uploadArea span, #uploadAreaSmall span {
      display: block;
      line-height: 1.4;
    }

    #uploadArea {
      width: 300px;
      height: 300px;
      margin: 0 auto 20px;
      font-size: 18px;
    }

    #uploadArea.dragover, #uploadAreaSmall.dragover {
      background-color: #d0e7ff;
      border-color: #0056b3;
      color: #0056b3;
    }

    #uploadAreaSmall {
      width: 200px;
      height: 80px;
      margin: 10px auto 30px;
      font-size: 14px;
      display: none;
    }

    #fileInput, #fileInputSmall {
      display: none;
    }

    #uploadedImage {
      display: none;
      margin: 0 auto 10px;
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      border: 1px solid #ccc;
      object-fit: contain;
    }

    #divider {
      width: 80%;
      height: 1px;
      background-color: #ccc;
      margin: 20px auto;
      display: none;
    }

    #visuals {
      display: none;
      flex-wrap: nowrap;
      justify-content: space-between;
      align-items: stretch;
      gap: 20px;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 40px;
      padding: 0 10px;

      opacity: 0;
      transition-property: opacity;
      transition-timing-function: ease-in-out;
    }

    .chartContainer {
      flex: 1 1 40%;
      aspect-ratio: 3 / 4;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      min-width: 100px;
    }

    #barChart {
      width: 100%;
      height: 100%;
    }

    #map {
      flex: 2 1 60%;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
      min-width: 500px;
    }

    #result {
      max-width: 600px;
      margin: 10px auto;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 13px;
      color: #333;
      display: none;
    }

    @media (max-width: 900px) {
      #visuals {
        flex-direction: column;
        align-items: center;
      }

      .chartContainer,
      #map {
        width: 100%;
        aspect-ratio: auto;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>


<body>

  <h1>Bildbasierte Geolokalisierung</h1>

  <label id="uploadArea" for="fileInput">
  <span>Bild hierher ziehen<br>oder Feld anklicken</span>
</label>
  <input type="file" id="fileInput" accept="image/*" />

  <img id="uploadedImage" alt="Hochgeladenes Bild wird hier angezeigt" />

  <label id="uploadAreaSmall" for="fileInputSmall">
    Neues Bild hierher ziehen oder klicken
  </label>
  <input type="file" id="fileInputSmall" accept="image/*" />

  <div id="divider"></div>

  <div id="visuals">
    <div class="chartContainer">
      <canvas id="barChart"></canvas>
    </div>
    <div id="map"></div>
  </div>

  <h2 id="newTitle" style="display: none; visibility: hidden;"></h2>
  <pre id="result" style="display: none; visibility: hidden;"></pre>


  <script>
    // Scrolling Animation script
    function smoothScrollTo(element) {
      const targetY = element.getBoundingClientRect().top + window.pageYOffset - window.innerHeight / 2 + element.offsetHeight / 2;
      const startY = window.pageYOffset;
      const distance = targetY - startY;
      const duration = 1000;
      let startTime = null;

      function step(currentTime) {
        if (!startTime) startTime = currentTime;
        const timeElapsed = currentTime - startTime;
        const progress = Math.min(timeElapsed / duration, 1);

        window.scrollTo(0, startY + distance * easeInOutQuad(progress));

        if (timeElapsed < duration) {
          requestAnimationFrame(step);
        }
      }

      function easeInOutQuad(t) {
        return t < 0.5 ? 2*t*t : -1 + (4 - 2*t)*t;
      }

      requestAnimationFrame(step);
    }

    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    function drawChart(data) {
      const ctx = document.getElementById('barChart').getContext('2d');
      if (window.myChart) window.myChart.destroy();

      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(data),
          datasets: [{
            label: 'Wahrscheinlichkeit (%)',
            data: Object.values(data).map(v => v * 100),
            backgroundColor: 'rgba(54, 162, 235, 0.7)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    }

    function showTopCountries(countries) {
      map.eachLayer(layer => {
        if (layer instanceof L.Circle) {
          map.removeLayer(layer);
        }
      });

      countries.forEach(({ name, lat, lon, probability }) => {
        const circle = L.circle([lat, lon], {
          color: 'blue',
          fillColor: 'blue',
          fillOpacity: probability,
          radius: 500000
        }).addTo(map);
        circle.bindPopup(`${name}: ${(probability * 100).toFixed(1)}%`);
      });

      if (countries.length > 0) {
        // Top country only
        const top = countries[0];
        map.setView([top.lat, top.lon], 3); // Map Zoomlevel, high = more zoom
      } else {
        map.setView([20, 0], 2);
      }
      map.invalidateSize();
    }

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadedImage = document.getElementById('uploadedImage');
    const uploadAreaSmall = document.getElementById('uploadAreaSmall');
    const fileInputSmall = document.getElementById('fileInputSmall');
    const divider = document.getElementById('divider');
    const visuals = document.getElementById('visuals');
    const resultPre = document.getElementById('result');
    
    let firstUploadDone = false;

    async function processFile(file) {
      if (!file) return;

      // Fade out
      if (visuals.style.display === 'flex') {
        visuals.style.transitionDuration = '400ms';
        visuals.style.opacity = 0;
        await new Promise(r => setTimeout(r, 400));
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        uploadedImage.src = e.target.result;
        uploadedImage.style.display = 'block';
      };
      reader.readAsDataURL(file);

      const formData = new FormData();
      formData.append('image', file);

      try {
        const response = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          resultPre.style.display = 'block';
          resultPre.textContent = 'Fehler beim Hochladen: ' + response.status;
          return;
        }

        const data = await response.json();
        resultPre.style.display = 'block';
        resultPre.textContent = JSON.stringify(data, null, 2);

        drawChart(data.probabilities);
        showTopCountries(data.topCountries);

        uploadArea.style.display = 'none';
        uploadAreaSmall.style.display = 'flex';
        divider.style.display = 'block';
        visuals.style.display = 'flex';
        visuals.style.transitionDuration = '1000ms';
        document.getElementById('newTitle').style.display = 'block';
        map.invalidateSize();

        // Fade in
        setTimeout(() => {
          visuals.style.opacity = 1;
        }, 400); // wait before fade in. time in ms

        document.getElementById('newTitle').style.display = 'block';
        map.invalidateSize();

        smoothScrollTo(visuals);

      } catch (error) {
        resultPre.style.display = 'block';
        resultPre.textContent = 'Netzwerkfehler: ' + error.message;
      }
    }

    fileInput.addEventListener('change', () => {
      processFile(fileInput.files[0]);
    });

    fileInputSmall.addEventListener('change', () => {
      processFile(fileInputSmall.files[0]);
    });

    function setupDragDrop(uploadLabel, fileInputElement) {
      uploadLabel.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadLabel.classList.add('dragover');
      });

      uploadLabel.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadLabel.classList.remove('dragover');
      });

      uploadLabel.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadLabel.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
          processFile(e.dataTransfer.files[0]);
          fileInputElement.value = '';
        }
      });
    }

    setupDragDrop(uploadArea, fileInput);
    setupDragDrop(uploadAreaSmall, fileInputSmall);
  </script>

</body>
</html>
